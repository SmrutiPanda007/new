!function(n){"use strict";var t=function(t,i){this.options=i;this.$element=n(t);this.$container=n("<div/>",{"class":"ms-container"});this.$selectableContainer=n("<div/>",{"class":"ms-selectable"});this.$selectionContainer=n("<div/>",{"class":"ms-selection"});this.$selectableUl=n("<ul/>",{"class":"ms-list",tabindex:"-1"});this.$selectionUl=n("<ul/>",{"class":"ms-list",tabindex:"-1"});this.scrollTo=0;this.elemsSelector="li:visible:not(.ms-optgroup-label,.ms-optgroup-container,."+i.disabledClass+")"};t.prototype={constructor:t,init:function(){var t=this,i=this.$element,r,u;if(i.next(".ms-container").length===0){i.css({position:"absolute",left:"-9999px"});i.attr("id",i.attr("id")?i.attr("id"):Math.ceil(Math.random()*1e3)+"multiselect");this.$container.attr("id","ms-"+i.attr("id"));this.$container.addClass(t.options.cssClass);i.find("option").each(function(){t.generateLisFromOption(this)});this.$selectionUl.find(".ms-optgroup-label").hide();t.options.selectableHeader&&t.$selectableContainer.append(t.options.selectableHeader);t.$selectableContainer.append(t.$selectableUl);t.options.selectableFooter&&t.$selectableContainer.append(t.options.selectableFooter);t.options.selectionHeader&&t.$selectionContainer.append(t.options.selectionHeader);t.$selectionContainer.append(t.$selectionUl);t.options.selectionFooter&&t.$selectionContainer.append(t.options.selectionFooter);t.$container.append(t.$selectableContainer);t.$container.append(t.$selectionContainer);i.after(t.$container);t.activeMouse(t.$selectableUl);t.activeKeyboard(t.$selectableUl);r=t.options.dblClick?"dblclick":"click";t.$selectableUl.on(r,".ms-elem-selectable",function(){t.select(n(this).data("ms-value"))});t.$selectionUl.on(r,".ms-elem-selection",function(){t.deselect(n(this).data("ms-value"))});t.activeMouse(t.$selectionUl);t.activeKeyboard(t.$selectionUl);i.on("focus",function(){t.$selectableUl.focus()})}u=i.find("option:selected").map(function(){return n(this).val()}).get();t.select(u,"init");typeof t.options.afterInit=="function"&&t.options.afterInit.call(this,this.$container)},generateLisFromOption:function(t,i){for(var e,s,y,p,r=this,d=r.$element,w="",h=n(t),a=0;a<t.attributes.length;a++)e=t.attributes[a],e.name!=="value"&&e.name!=="disabled"&&(w+=e.name+'="'+e.value+'" ');var o=n("<li "+w+"><span>"+r.escapeHTML(h.text())+"<\/span><\/li>"),c=o.clone(),v=h.val(),b=r.sanitize(v);if(o.data("ms-value",v).addClass("ms-elem-selectable").attr("id",b+"-selectable"),c.data("ms-value",v).addClass("ms-elem-selection").attr("id",b+"-selection").hide(),(h.prop("disabled")||d.prop("disabled"))&&(c.addClass(r.options.disabledClass),o.addClass(r.options.disabledClass)),s=h.parent("optgroup"),s.length>0){var k=s.attr("label"),l=r.sanitize(k),u=r.$selectableUl.find("#optgroup-selectable-"+l),f=r.$selectionUl.find("#optgroup-selection-"+l);if(u.length===0){if(y='<li class="ms-optgroup-container"><\/li>',p='<ul class="ms-optgroup"><li class="ms-optgroup-label"><span>'+k+"<\/span><\/li><\/ul>",u=n(y),f=n(y),u.attr("id","optgroup-selectable-"+l),f.attr("id","optgroup-selection-"+l),u.append(n(p)),f.append(n(p)),r.options.selectableOptgroup){u.find(".ms-optgroup-label").on("click",function(){var t=s.children(":not(:selected)").map(function(){return n(this).val()}).get();r.select(t)});f.find(".ms-optgroup-label").on("click",function(){var t=s.children(":selected").map(function(){return n(this).val()}).get();r.deselect(t)})}r.$selectableUl.append(u);r.$selectionUl.append(f)}i=i==undefined?u.children().length:i+1;o.insertAt(i,u.children());c.insertAt(i,f.children())}else i=i==undefined?r.$selectableUl.children().length:i,o.insertAt(i,r.$selectableUl),c.insertAt(i,r.$selectionUl)},addOption:function(t){var i=this;t.value&&(t=[t]);n.each(t,function(t,r){if(r.value&&i.$element.find("option[value='"+r.value+"']").length===0){var u=n('<option value="'+r.value+'">'+r.text+"<\/option>"),t=parseInt(typeof r.index=="undefined"?i.$element.children().length:r.index),f=r.nested==undefined?i.$element:n("optgroup[label='"+r.nested+"']");u.insertAt(t,f);i.generateLisFromOption(u.get(0),t,r.nested)}})},escapeHTML:function(t){return n("<div>").text(t).html()},activeKeyboard:function(t){var i=this;t.on("focus",function(){n(this).addClass("ms-focus")}).on("blur",function(){n(this).removeClass("ms-focus")}).on("keydown",function(r){switch(r.which){case 40:case 38:r.preventDefault();r.stopPropagation();i.moveHighlight(n(this),r.which===38?-1:1);return;case 37:case 39:r.preventDefault();r.stopPropagation();i.switchList(t);return;case 9:if(i.$element.is("[tabindex]")){r.preventDefault();var u=parseInt(i.$element.attr("tabindex"),10);u=r.shiftKey?u-1:u+1;n('[tabindex="'+u+'"]').focus();return}r.shiftKey&&i.$element.trigger("focus")}if(n.inArray(r.which,i.options.keySelect)>-1){r.preventDefault();r.stopPropagation();i.selectHighlighted(t);return}})},moveHighlight:function(n,t){var r=n.find(this.elemsSelector),f=r.filter(".ms-hover"),i=null,c=r.first().outerHeight(),l=n.height(),a="#"+this.$container.prop("id"),o,u,e,s,h;r.off("mouseenter");r.removeClass("ms-hover");t===1?(i=f.nextAll(this.elemsSelector).first(),i.length===0&&(u=f.parent(),u.hasClass("ms-optgroup")?(e=u.parent(),o=e.next(":visible"),i=o.length>0?o.find(this.elemsSelector).first():r.first()):i=r.first())):t===-1&&(i=f.prevAll(this.elemsSelector).first(),i.length===0&&(u=f.parent(),u.hasClass("ms-optgroup")?(e=u.parent(),s=e.prev(":visible"),i=s.length>0?s.find(this.elemsSelector).last():r.last()):i=r.last()));i.length>0&&(i.addClass("ms-hover"),h=n.scrollTop()+i.position().top-l/2+c/2,n.scrollTop(h))},selectHighlighted:function(n){var i=n.find(this.elemsSelector),t=i.filter(".ms-hover").first();t.length>0&&(n.parent().hasClass("ms-selectable")?this.select(t.data("ms-value")):this.deselect(t.data("ms-value")),i.removeClass("ms-hover"))},switchList:function(n){n.blur();n.parent().hasClass("ms-selectable")?this.$selectionUl.focus():this.$selectableUl.focus()},activeMouse:function(t){var r=this,i=!1;t.on("mousemove",function(){if(i!==this){i=this;var u=t.find(r.elemsSelector);u.on("mouseenter",function(){u.removeClass("ms-hover");n(this).addClass("ms-hover")})}})},refresh:function(){this.destroy();this.$element.multiSelect(this.options)},destroy:function(){n("#ms-"+this.$element.attr("id")).remove();this.$element.css("position","").css("left","");this.$element.removeData("multiselect")},select:function(t,i){var s,c,e;typeof t=="string"&&(t=[t]);var r=this,h=this.$element,u=n.map(t,function(n){return r.sanitize(n)}),o=this.$selectableUl.find("#"+u.join("-selectable, #")+"-selectable").filter(":not(."+r.options.disabledClass+")"),f=this.$selectionUl.find("#"+u.join("-selection, #")+"-selection").filter(":not(."+r.options.disabledClass+")"),l=h.find("option:not(:disabled)").filter(function(){return n.inArray(this.value,t)>-1});i==="init"&&(o=this.$selectableUl.find("#"+u.join("-selectable, #")+"-selectable"),f=this.$selectionUl.find("#"+u.join("-selection, #")+"-selection"));o.length>0&&(o.addClass("ms-selected").hide(),f.addClass("ms-selected").show(),l.prop("selected",!0),s=r.$selectableUl.children(".ms-optgroup-container"),s.length>0?(s.each(function(){var t=n(this).find(".ms-elem-selectable");t.length===t.filter(".ms-selected").length&&n(this).find(".ms-optgroup-label").hide()}),c=r.$selectionUl.children(".ms-optgroup-container"),c.each(function(){var t=n(this).find(".ms-elem-selection");t.filter(".ms-selected").length>0&&n(this).find(".ms-optgroup-label").show()})):r.options.keepOrder&&i!=="init"&&(e=r.$selectionUl.find(".ms-selected"),e.length>1&&e.last().get(0)!=f.get(0)&&f.insertAfter(e.last())),i!=="init"&&(h.trigger("change"),typeof r.options.afterSelect=="function"&&r.options.afterSelect.call(this,t)))},deselect:function(t){var r,o;typeof t=="string"&&(t=[t]);var i=this,u=this.$element,f=n.map(t,function(n){return i.sanitize(n)}),s=this.$selectableUl.find("#"+f.join("-selectable, #")+"-selectable"),e=this.$selectionUl.find("#"+f.join("-selection, #")+"-selection").filter(".ms-selected").filter(":not(."+i.options.disabledClass+")"),h=u.find("option").filter(function(){return n.inArray(this.value,t)>-1});e.length>0&&(s.removeClass("ms-selected").show(),e.removeClass("ms-selected").hide(),h.prop("selected",!1),r=i.$selectableUl.children(".ms-optgroup-container"),r.length>0&&(r.each(function(){var t=n(this).find(".ms-elem-selectable");t.filter(":not(.ms-selected)").length>0&&n(this).find(".ms-optgroup-label").show()}),o=i.$selectionUl.children(".ms-optgroup-container"),o.each(function(){var t=n(this).find(".ms-elem-selection");t.filter(".ms-selected").length===0&&n(this).find(".ms-optgroup-label").hide()})),u.trigger("change"),typeof i.options.afterDeselect=="function"&&i.options.afterDeselect.call(this,t))},select_all:function(){var t=this.$element,r=t.val(),i;t.find('option:not(":disabled")').prop("selected",!0);this.$selectableUl.find(".ms-elem-selectable").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").hide();this.$selectionUl.find(".ms-optgroup-label").show();this.$selectableUl.find(".ms-optgroup-label").hide();this.$selectionUl.find(".ms-elem-selection").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").show();this.$selectionUl.focus();t.trigger("change");typeof this.options.afterSelect=="function"&&(i=n.grep(t.val(),function(t){return n.inArray(t,r)<0}),this.options.afterSelect.call(this,i))},deselect_all:function(){var n=this.$element,t=n.val();n.find("option").prop("selected",!1);this.$selectableUl.find(".ms-elem-selectable").removeClass("ms-selected").show();this.$selectionUl.find(".ms-optgroup-label").hide();this.$selectableUl.find(".ms-optgroup-label").show();this.$selectionUl.find(".ms-elem-selection").removeClass("ms-selected").hide();this.$selectableUl.focus();n.trigger("change");typeof this.options.afterDeselect=="function"&&this.options.afterDeselect.call(this,t)},sanitize:function(n){var t=0,i,u,r;if(n.length==0)return t;for(r=0,i=0,r=n.length;i<r;i++)u=n.charCodeAt(i),t=(t<<5)-t+u|0;return t}};n.fn.multiSelect=function(){var i=arguments[0],r=arguments;return this.each(function(){var f=n(this),u=f.data("multiselect"),e=n.extend({},n.fn.multiSelect.defaults,f.data(),typeof i=="object"&&i);u||f.data("multiselect",u=new t(this,e));typeof i=="string"?u[i](r[1]):u.init()})};n.fn.multiSelect.defaults={keySelect:[32],selectableOptgroup:!1,disabledClass:"disabled",dblClick:!1,keepOrder:!1,cssClass:""};n.fn.multiSelect.Constructor=t;n.fn.insertAt=function(n,t){return this.each(function(){n===0?t.prepend(this):t.children().eq(n-1).after(this)})}}(window.jQuery)